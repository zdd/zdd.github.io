<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
<meta property="og:type" content="website">
<meta property="og:title" content="Philip">
<meta property="og:url" content="http://example.com/page/6/index.html">
<meta property="og:site_name" content="Philip">
<meta property="og:description" content="青春都一餉，忍把浮名換了代碼輕狂。">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Philip Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Philip</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Philip</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Philip's blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/14/angular-customize-webpack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/14/angular-customize-webpack/" class="post-title-link" itemprop="url">angular-customize-webpack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-14 21:23:49 / Modified: 21:52:06" itemprop="dateCreated datePublished" datetime="2024-09-14T21:23:49+08:00">2024-09-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Angular 隐藏了项目构建的细节，其构建过程通过各种Builder来实现，底层可以使用Webpack或者ESBuild（从Angular17开始，默认使用ESBuild），那么我们需要修改Webpack配置怎么办呢？其实只有一个办法，那就是通过第三方npm package，这里介绍目前流行的两个。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/ngx-build-plus">ngx-build-plus</a> - Angular Module Federation也是用的这个package来做Webpack定制化。</li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@angular-builders/custom-webpack">@angular-builders&#x2F;custom-webpack</a></li>
</ul>
<p>这两者的实现原理也比较简单，都是通过继承<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@angular-devkit/build-angular">@angular-devkit&#x2F;build-angular</a>来实现的。</p>
<p>下面我们分别看看，这两个package的使用方法。</p>
<h2 id="ngx-build-plus"><a href="#ngx-build-plus" class="headerlink" title="ngx-build-plus"></a>ngx-build-plus</h2><h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install ngx-build-plus --save-dev</span><br></pre></td></tr></table></figure>

<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><p><code>angular.json</code>(for Angular project) or <code>project.json</code>(For Nx based mono repo)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;architect&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;builder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ngx-build-plus:browser&quot;</span><span class="punctuation">,</span> <span class="comment">// change builder</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;extraWebpackConfig&quot;</span><span class="punctuation">:</span> <span class="string">&quot;extra-webpack.config.js&quot;</span> <span class="comment">// supply a path to the custom webpack config</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="angular-builders-x2F-custom-webpack"><a href="#angular-builders-x2F-custom-webpack" class="headerlink" title="@angular-builders&#x2F;custom-webpack"></a>@angular-builders&#x2F;custom-webpack</h2><h3 id="Installation-1"><a href="#Installation-1" class="headerlink" title="Installation"></a>Installation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @angular-builders/custom-webpack --save-dev</span><br></pre></td></tr></table></figure>

<h3 id="Usage-1"><a href="#Usage-1" class="headerlink" title="Usage"></a>Usage</h3><p><code>angular.json</code>(for Angular project) or <code>project.json</code>(For Nx based mono repo)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;architect&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;builder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@angular-builders/custom-webpack:browser&quot;</span><span class="punctuation">,</span> <span class="comment">// change builder</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;customWebpackConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./extra-webpack.config.js&quot;</span><span class="punctuation">,</span> <span class="comment">// supply a path to the custom webpack config</span></span><br><span class="line">          <span class="attr">&quot;mergeStrategies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;externals&quot;</span><span class="punctuation">:</span> <span class="string">&quot;replace&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="How-to-choose"><a href="#How-to-choose" class="headerlink" title="How to choose?"></a>How to choose?</h2><ol>
<li>If you are using Angular Module Federation, you should use <code>ngx-build-plus</code>, and it is installed automatically when you create a new Angular project with Angular Module Federation. This package has not been upgraded for a long time, but it is still working. <code>ngx-build-plus</code> support <code>hooks</code>.</li>
<li>If you are not using Angular Module Federation, you can choose either of them, but <code>@angular-builders/custom-webpack</code> is more popular. This package is upgraded frequently.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/12/angular-build-process/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/12/angular-build-process/" class="post-title-link" itemprop="url">angular-build-process</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-12 20:45:25" itemprop="dateCreated datePublished" datetime="2024-09-12T20:45:25+08:00">2024-09-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-14 10:08:40" itemprop="dateModified" datetime="2024-09-14T10:08:40+08:00">2024-09-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Angular的编译过程是怎样的？<br>通常我么使用<code>ng build</code>命令来编译Angular项目，但是这个命令背后的逻辑是怎样的呢？</p>
<ul>
<li><code>ng build</code>命令底层是用<code>WebPack</code>还是<code>ESBuild</code>？</li>
<li><code>ng build</code>命令是如何处理<code>TypeScript</code>文件的？</li>
<li><code>ng build</code>命令是如何处理<code>HTML</code>文件的？</li>
</ul>
<h2 id="ts-x2F-js编译"><a href="#ts-x2F-js编译" class="headerlink" title="ts&#x2F;js编译"></a>ts&#x2F;js编译</h2><p>Webpack的配置文件在这里：<code>packages/angular_devkit/build_angular/src/tools/webpack/configs/common.ts</code></p>
<p>这个文件里我们可以看到如下<code>rule</code>配置：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">test</span>: <span class="regexp">/\.[cm]?[tj]sx?$/</span>,</span><br><span class="line">  <span class="comment">// The below is needed due to a bug in `@babel/runtime`. See: https://github.com/babel/babel/issues/12824</span></span><br><span class="line">  <span class="attr">resolve</span>: &#123; <span class="attr">fullySpecified</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">  <span class="attr">exclude</span>: [</span><br><span class="line">    <span class="regexp">/[\\/]node_modules[/\\](?:core-js|@babel|tslib|web-animations-js|web-streams-polyfill|whatwg-url)[/\\]/</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">use</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">loader</span>: <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;../../babel/webpack-loader&#x27;</span>),</span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">cacheDirectory</span>: (cache.<span class="property">enabled</span> &amp;&amp; path.<span class="title function_">join</span>(cache.<span class="property">path</span>, <span class="string">&#x27;babel-webpack&#x27;</span>)) || <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">aot</span>: buildOptions.<span class="property">aot</span>,</span><br><span class="line">        <span class="attr">optimize</span>: buildOptions.<span class="property">buildOptimizer</span>,</span><br><span class="line">        <span class="attr">supportedBrowsers</span>: buildOptions.<span class="property">supportedBrowsers</span>,</span><br><span class="line">        <span class="attr">instrumentCode</span>: codeCoverage</span><br><span class="line">          ? &#123;</span><br><span class="line">              <span class="attr">includedBasePath</span>: sourceRoot ?? projectRoot,</span><br><span class="line">              <span class="attr">excludedPaths</span>: <span class="title function_">getInstrumentationExcludedPaths</span>(root, codeCoverageExclude),</span><br><span class="line">            &#125;</span><br><span class="line">          : <span class="literal">undefined</span>,</span><br><span class="line">      &#125; <span class="keyword">as</span> <span class="title class_">AngularBabelLoaderOptions</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>可以看到这个正则表达式匹配的是：</p>
<ul>
<li><code>.ts</code>、<code>.tsx</code></li>
<li><code>.js</code>、<code>.jsx</code></li>
<li><code>.cjs</code>、<code>.mjs</code></li>
</ul>
<p>这些文件都会被<code>require.resolve(&#39;../../babel/webpack-loader&#39;)</code>这个loader处理。而这个loader的代码在这里：<code>packages/angular_devkit/build_angular/src/tools/babel/webpack-loader.ts</code></p>
<p>这个文件里面又调用了babelLoader。所以可知，<code>ng build</code>命令底层是用<code>Babel</code>来处理<code>TypeScript</code>文件的。</p>
<p>这里可以画一个流程图：ng build -&gt; Webpack -&gt; Babel -&gt; TypeScript</p>
<h2 id="scss-x2F-sass-x2F-less-x2F-css编译"><a href="#scss-x2F-sass-x2F-less-x2F-css编译" class="headerlink" title="scss&#x2F;sass&#x2F;less&#x2F;css编译"></a>scss&#x2F;sass&#x2F;less&#x2F;css编译</h2><p>Webpack通过各种loader来处理不同类型的文件，比如<code>css-loader</code>、<code>sass-loader</code>、<code>less-loader</code>等。那么什么是loader呢？loader是一个转换器，负责把一种文件格式转换为另一种文件格式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">output_format = loader(input_format)</span><br></pre></td></tr></table></figure>

<p>loader是可以链式调用的，上一个loader的输出可以作为下一个loader的输入，比如<code>scss</code>文件可以先经过<code>sass-loader</code>处理，然后再经过<code>css-loader</code>处理，最后再经过<code>style-loader</code>处理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">output_format = style-loader(css-loader(sass-loader(input_format)))</span><br></pre></td></tr></table></figure>

<p>Angular默认采用<code>scss</code>作为样式文件的扩展名，所以我们可以看到<code>scss</code>文件是如何被处理的：Webpack中关于样式文件的配置在这里：<code>packages/angular_devkit/build_angular/src/tools/webpack/configs/styles.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">extensions</span>: [<span class="string">&#x27;scss&#x27;</span>],</span><br><span class="line">  <span class="attr">use</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">loader</span>: <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;resolve-url-loader&#x27;</span>),</span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">sourceMap</span>: cssSourceMap,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">loader</span>: <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;sass-loader&#x27;</span>),</span><br><span class="line">      <span class="attr">options</span>: <span class="title function_">getSassLoaderOptions</span>(</span><br><span class="line">        root,</span><br><span class="line">        sassImplementation,</span><br><span class="line">        includePaths,</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        !!buildOptions.<span class="property">verbose</span>,</span><br><span class="line">        !!buildOptions.<span class="property">preserveSymlinks</span>,</span><br><span class="line">      ),</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="html编译"><a href="#html编译" class="headerlink" title="html编译"></a>html编译</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/09/angular-how-ng-serve-works/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/09/angular-how-ng-serve-works/" class="post-title-link" itemprop="url">angular-how-ng-serve-works</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-09 22:19:19" itemprop="dateCreated datePublished" datetime="2024-09-09T22:19:19+08:00">2024-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 10:30:46" itemprop="dateModified" datetime="2024-09-19T10:30:46+08:00">2024-09-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Angular的CLI(Command Line Interface)系统非常强大，它提供了丰富的命令用来构建，测试，运行Angular程序，今天我们就从源码的角度来看看cli中的<code>ng serve</code>命令是如何工作的。</p>
<p><code>ng serve</code>是我们日常频繁使用的命令，它用来本地启动Angular项目，检测代码更新以做出响应，但是用了这么久的命令，你了解它的底层逻辑吗？下面的几个问题你是否思考过？</p>
<ol>
<li><code>ng serve</code>命令为什么没有输出文件到dist目录？</li>
<li><code>ng serve</code>命令是如何启动一个web server的？</li>
<li><code>ng serve</code>命令是如何监控文件变化的？</li>
<li><code>ng serve</code>命令是如何实现热更新的？</li>
</ol>
<p>下面就让我们开始这段愉快而又漫长的探索之旅吧！</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>为了调试<code>ng serve</code>命令，我们需要准备一个Angular项目，为了方便查看源码，我们将<a target="_blank" rel="noopener" href="https://github.com/angular/angular-cli">angluar-cli</a>的源码也下载到本地，然后打开两个IDE，一个查看待调试的项目代码，一个查看<code>angular-cli</code>的源码。对照起来看，简直不要太爽！</p>
<h2 id="从命令行开始"><a href="#从命令行开始" class="headerlink" title="从命令行开始"></a>从命令行开始</h2><p>如果你直接查看<code>ng serve</code>命令的源码，可能得不到什么有用的信息，<code>serve</code>命令对应的源码在这里：<code>packages/angular/cli/src/commands/serve/cli.ts</code>， 从以下代码可知，<code>serve</code>命令是继承自<code>ArchitectCommandModule</code>的，同时也实现了<code>CommandModuleImplementation</code>接口。而该文件本身只是做了一个简单的配置，具体的实现逻辑都在<code>ArchitectCommandModule</code>和<code>CommandModuleImplementation</code>中。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">ServeCommandModule</span></span><br><span class="line">  <span class="keyword">extends</span> <span class="title class_ inherited__">ArchitectCommandModule</span></span><br><span class="line">  <span class="keyword">implements</span> <span class="title class_">CommandModuleImplementation</span></span><br><span class="line">&#123;</span><br><span class="line">  multiTarget = <span class="literal">false</span>;</span><br><span class="line">  command = <span class="string">&#x27;serve [project]&#x27;</span>;</span><br><span class="line">  aliases = <span class="title class_">RootCommands</span>[<span class="string">&#x27;serve&#x27;</span>].<span class="property">aliases</span>;</span><br><span class="line">  describe = <span class="string">&#x27;Builds and serves your application, rebuilding on file changes.&#x27;</span>;</span><br><span class="line">  longDescriptionPath?: <span class="built_in">string</span> | <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还是调试吧，我们打开Angular项目，然后打开项目根目录下的<code>package.json</code>文件，找到<code>scripts</code>字段，你会看到如下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;ng&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng serve&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng build&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;watch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng build --watch --configuration development&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;compile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ngc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jest --verbose&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;test:watch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jest --watch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;prepare&quot;</span><span class="punctuation">:</span> <span class="string">&quot;husky install&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<p>想要深入理解<code>ng serve</code>命令，我们需要先了解<code>start</code>命令是如何工作的。我们通过调式该命令的方式来了解<code>ng serve</code>的底层逻辑。不同的IDE对应不同的调试方式：</p>
<ul>
<li>WebStorm: 点击<code>start</code>命令左侧的绿色三角按钮，然后选择<code>Debug &#39;start&#39;</code>，这样就可以进入<code>ng serve</code>的源码了。</li>
<li>VSCode: 鼠标悬停到<code>start</code>命令上，点击<code>Debug</code>按钮，这样就可以进入<code>ng serve</code>的源码了。</li>
</ul>
<p>使用这种方法可以进入调试状态，但是我们要在哪里设置断点呢？</p>
<p>对于<code>package.json</code>中的script区块中的命令，其实他们都对应<code>node_modules/.bin</code>下面的一个文件。以<code>ng serve</code>为例，因为它的命令由<code>ng</code>来引导，那么我们首先到<code>node_modules/.bin</code>目录下找到<code>ng</code>文件。</p>
<p>可是我们找到了三个<code>ng</code>文件，分别是<code>ng</code>, <code>ng.cmd</code>, <code>ng.ps1</code>，那么我们应该选择哪一个呢？其实通过扩展名就能看出来，我这里使用的是Windows系统，所以我们选择<code>ng.cmd</code>文件。</p>
<ul>
<li>ng - Unix shell script</li>
<li>ng.cmd - Windows batch file</li>
<li>ng.ps1 - Windows PowerShell script</li>
</ul>
<p>用记事本打开这个文件看看它的代码:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">ECHO</span> off</span><br><span class="line"><span class="keyword">GOTO</span> <span class="built_in">start</span></span><br><span class="line">:find_dp0</span><br><span class="line"><span class="built_in">SET</span> dp0=%~dp0</span><br><span class="line"><span class="keyword">EXIT</span> /b</span><br><span class="line">:<span class="built_in">start</span></span><br><span class="line"><span class="built_in">SETLOCAL</span></span><br><span class="line"><span class="keyword">CALL</span> :find_dp0</span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXIST</span> &quot;<span class="variable">%dp0%</span>\node.exe&quot; (</span><br><span class="line">  <span class="built_in">SET</span> &quot;_prog=<span class="variable">%dp0%</span>\node.exe&quot;</span><br><span class="line">) <span class="keyword">ELSE</span> (</span><br><span class="line">  <span class="built_in">SET</span> &quot;_prog=node&quot;</span><br><span class="line">  <span class="built_in">SET</span> PATHEXT=<span class="variable">%PATHEXT:;.JS;=;%</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">endLocal</span> &amp; <span class="keyword">goto</span> #_undefined_# <span class="number">2</span>&gt;<span class="built_in">NUL</span> || <span class="built_in">title</span> <span class="variable">%COMSPEC%</span> &amp; &quot;<span class="variable">%_prog%</span>&quot;  &quot;<span class="variable">%dp0%</span>\..\@angular\cli\bin\ng.js&quot; %*</span><br></pre></td></tr></table></figure>
<p>我们不必纠结于每一行代码的含义，简单分析下来，我们可以推断出这个脚本的作用就是用<code>node.exe</code>来调用<code>@angular/cli/bin/ng.js</code>文件。</p>
<p>好了，我们再去看一下这个<code>ng.js</code>文件，这个文件就是Angular CLI的入口文件。ng.js调用了同一目录下的<code>bootstrap.js</code>文件，<code>bootstrap.js</code>文件调用了<code>lib/init.ts</code>文件。<code>init.ts</code>又调用了<code>lib/cli/index.ts</code>文件，后续又有一大堆的调用。</p>
<p><code>bin/ng.js</code> –&gt; <code>bin/bootstrap.js</code> –&gt; <code>lib/init.ts</code> –&gt; <code>lib/cli/index.ts</code> –&gt; …</p>
<p>通过不断的设置断点并调试得知，最终在文件<code>packages/angular/cli/src/command-builder/architect-base-command-module.ts</code>中通过解析项目的配置文件<code>angular.json</code>，找到<code>serve</code>命令对应的<code>builder</code>，然后通过调用那个<code>builder</code>来启动一个web server。</p>
<p><code>architect-base-command-module.ts</code>对应的代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">async</span> <span class="title function_">runSingleTarget</span>(<span class="attr">target</span>: <span class="title class_">Target</span>, <span class="attr">options</span>: <span class="title class_">OtherOptions</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> architectHost = <span class="variable language_">this</span>.<span class="title function_">getArchitectHost</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">builderName</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    builderName = <span class="keyword">await</span> architectHost.<span class="title function_">getBuilderNameForTarget</span>(target); <span class="comment">// 获取builder名称</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="title function_">assertIsError</span>(e);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">onMissingTarget</span>(e.<span class="property">message</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h2 id="Webpack配置在哪里？"><a href="#Webpack配置在哪里？" class="headerlink" title="Webpack配置在哪里？"></a>Webpack配置在哪里？</h2><p>我们都知道，<code>ng serve</code>命令启动的是一个web server，而这是通过<code>webpack-dev-server</code>来实现的，那么这个webpack-dev-server的配置在哪里呢？我么可以在源码中找到如下目录：<br><code>packages/angular_devkit/build_angular/src/tools/webpack/configs/common.ts</code>，这个目录下有四个文件：</p>
<ul>
<li><code>common.ts</code> - 通用配置，主要是打包配置</li>
<li><code>dev-server.ts</code> - 开发服务器配置 - 我们要找的配置就在这里。</li>
<li><code>styles.ts</code> - 样式配置，用来处理各种样式文件, 如css, scss&#x2F;sass, less等</li>
<li><code>index.ts</code> - 导出上面三个文件</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Angular的CLI命令对应的逻辑源码并不在CLI命令本身中，而是在对应的builder中，builder源码在这个目录下：</p>
<ul>
<li><code>packages/angular/build/src/builders</code> - application builder</li>
<li><code>packages/angular_devkit/build_angular/src/builders</code> - other builders</li>
</ul>
<p>关于builder的详细介绍，可以参考之前的一篇博文：<a target="_blank" rel="noopener" href="https://zdd.github.io/2024/06/06/angular-builders/%EF%BC%8C">https://zdd.github.io/2024/06/06/angular-builders/，</a> 也可以参考Angular官方文档：<a target="_blank" rel="noopener" href="https://angular.dev/tools/cli/cli-builder/">https://angular.dev/tools/cli/cli-builder/</a></p>
<ul>
<li>ng server works in memory and never generate files to dist folder</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/03/angular-test-fixture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/03/angular-test-fixture/" class="post-title-link" itemprop="url">angular-test-fixture</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-03 09:58:05" itemprop="dateCreated datePublished" datetime="2024-09-03T09:58:05+08:00">2024-09-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-11 19:35:49" itemprop="dateModified" datetime="2024-09-11T19:35:49+08:00">2024-09-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="What’s-Fixture"><a href="#What’s-Fixture" class="headerlink" title="What’s Fixture?"></a>What’s Fixture?</h2><p>先解释一下<code>fixture</code>这个单词，它的意思是固定设施，比如室内的浴缸或抽水马桶。当然这里指的是测试中的固定设施，也就是我们要测试的组件。在Angular中，我们可以通过<code>TestBed</code>来创建一个组件的<code>fixture</code>，然后对这个<code>fixture</code>进行测试。</p>
<p>通常来说，<code>fixture</code>都是在<code>beforeEach</code>中创建。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;ProductComponent&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">component</span>: <span class="title class_">ProductComponent</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">fixture</span>: <span class="title class_">ComponentFixture</span>&lt;<span class="title class_">ProductComponent</span>&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">beforeEach</span>(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">TestBed</span>.<span class="title function_">configureTestingModule</span>(&#123;</span><br><span class="line">      <span class="attr">imports</span>: [<span class="title class_">ProductComponent</span>] <span class="comment">// import standalone component</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">compileComponents</span>();</span><br><span class="line"></span><br><span class="line">    fixture = <span class="title class_">TestBed</span>.<span class="title function_">createComponent</span>(<span class="title class_">ProductComponent</span>); <span class="comment">// create fixture</span></span><br><span class="line">    component = fixture.<span class="property">componentInstance</span>;</span><br><span class="line">    fixture.<span class="title function_">detectChanges</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&#x27;should create&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">expect</span>(component).<span class="title function_">toBeTruthy</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="fixture-detectChanges"><a href="#fixture-detectChanges" class="headerlink" title="fixture.detectChanges()"></a>fixture.detectChanges()</h2><p><code>fixture.detectChanges()</code>是用来触发组件的变更检测的，也就是说，当我们对组件的状态进行了修改之后，我们需要调用<code>fixture.detectChanges()</code>来通知Angular进行变更检测，以便更新视图。<br>如果你的测试中包含对UI的检测，那么你就需要调用<code>fixture.detectChanges()</code>。否则不需要。<br>来，举个例子！</p>
<p>We have a product component which just display the product name as ‘Computer’, and when user click the <code>Change product name</code> button, we’ll update the product name to ‘Phone’.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  <span class="attr">selector</span>: <span class="string">&#x27;app-product&#x27;</span>,</span><br><span class="line">  <span class="attr">standalone</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">imports</span>: [],</span><br><span class="line">  <span class="attr">templateUrl</span>: <span class="string">&#x27;./product.component.html&#x27;</span>,</span><br><span class="line">  <span class="attr">styleUrl</span>: <span class="string">&#x27;./product.component.css&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ProductComponent</span> &#123;</span><br><span class="line">  name = <span class="string">&#x27;Computer&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">changeName</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;Phone&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;product-name&quot;</span>&gt;</span>Product name: &#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">&quot;changeName()&quot;</span>&gt;</span>Change product name<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Does this test case work?</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should have name as Computer&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  component.<span class="title function_">changeName</span>();</span><br><span class="line">  fixture.<span class="title function_">detectChanges</span>();</span><br><span class="line">  <span class="title function_">expect</span>(component.<span class="property">name</span>).<span class="title function_">toEqual</span>(<span class="string">&#x27;Phone&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Yes, it works, but, we don’t need to call <code>fixture.detectChanges()</code> here, because we are testing the component’s property <code>name</code> change directly, not the UI changes.</p>
<p>Does the following test case work?</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should change name&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  component.<span class="title function_">changeName</span>();</span><br><span class="line">  <span class="keyword">const</span> compiled = fixture.<span class="property">nativeElement</span>;</span><br><span class="line">  <span class="title function_">expect</span>(compiled.<span class="title function_">querySelector</span>(<span class="string">&#x27;#product-name&#x27;</span>).<span class="property">textContent</span>).<span class="title function_">toContain</span>(<span class="string">&#x27;Phone&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>No, it doesn’t work, because, you call <code>component.changeName()</code> to change the product name, but you didn’t call <code>fixture.detectChanges()</code> to trigger the change detection and update the view. so the product name on page is still ‘Computer’.</p>
<p>We can call <code>fixture.detectChanges()</code> after <code>component.changeName()</code> to fix this issue.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should change name&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  component.<span class="title function_">changeName</span>();</span><br><span class="line">  fixture.<span class="title function_">detectChanges</span>();</span><br><span class="line">  <span class="keyword">const</span> compiled = fixture.<span class="property">nativeElement</span>;</span><br><span class="line">  <span class="title function_">expect</span>(compiled.<span class="title function_">querySelector</span>(<span class="string">&#x27;#product-name&#x27;</span>).<span class="property">textContent</span>).<span class="title function_">toContain</span>(<span class="string">&#x27;Phone&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="fixture-whenStable"><a href="#fixture-whenStable" class="headerlink" title="fixture.whenStable()"></a>fixture.whenStable()</h2><p><code>fixture.whenStable()</code>是用来等待异步任务完成的，为了使用这个函数，我们给product component添加一个异步任务，比如通过<code>setTimeout</code>来模拟一个异步任务。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(<span class="string">&#x27;Keyboard&#x27;</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">updateName</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getData</span>() <span class="keyword">as</span> <span class="built_in">unknown</span> <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> (<span class="attr">click</span>)=<span class="string">&quot;updateName()&quot;</span>&gt;</span>Update name<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接下来，我们测试一下<code>updateName</code>方法。下面这个test case,没有调用<code>fixture.detectChanges()</code>，但是仍然可以通过测试，为什么呢？</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should update name&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  component.<span class="title function_">updateName</span>();</span><br><span class="line">  fixture.<span class="title function_">whenStable</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">expect</span>(component.<span class="property">name</span>).<span class="title function_">toEqual</span>(<span class="string">&#x27;Keyboard&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> compiled = fixture.<span class="property">nativeElement</span>;</span><br><span class="line">    <span class="title function_">expect</span>(compiled.<span class="title function_">querySelector</span>(<span class="string">&#x27;#product-name&#x27;</span>).<span class="property">textContent</span>).<span class="title function_">toContain</span>(<span class="string">&#x27;Keyboard&#x27;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>其实，这个test case是有问题的，它根本没有通过测试，虽然我们使用<code>async</code>标记了测试方法，但是<code>async</code>要配合<code>await</code>使用，而不是<code>then</code>，实际上，这里的<code>then</code>根本没有执行！</p>
<p>为了修复这个test case，我们可以将<code>async</code>删除。（<strong>这里有待验证！！！</strong>）</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should update name&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> component.<span class="title function_">updateName</span>();</span><br><span class="line">  fixture.<span class="title function_">detectChanges</span>();</span><br><span class="line">  fixture.<span class="title function_">whenStable</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">expect</span>(component.<span class="property">name</span>).<span class="title function_">toEqual</span>(<span class="string">&#x27;Keyboard&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> compiled = fixture.<span class="property">nativeElement</span>;</span><br><span class="line">    <span class="title function_">expect</span>(compiled.<span class="title function_">querySelector</span>(<span class="string">&#x27;#product-name&#x27;</span>).<span class="property">textContent</span>).<span class="title function_">toContain</span>(<span class="string">&#x27;Keyboard&#x27;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>其实，这里根本就不需要<code>fixture.whenStable()</code>，因为我们使用了<code>await</code>，它会等待异步任务完成，所以我们可以直接这样写：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should update name&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> component.<span class="title function_">updateName</span>();</span><br><span class="line">  fixture.<span class="title function_">detectChanges</span>();</span><br><span class="line">  <span class="title function_">expect</span>(component.<span class="property">name</span>).<span class="title function_">toEqual</span>(<span class="string">&#x27;Keyboard&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> compiled = fixture.<span class="property">nativeElement</span>;</span><br><span class="line">  <span class="title function_">expect</span>(compiled.<span class="title function_">querySelector</span>(<span class="string">&#x27;#product-name&#x27;</span>).<span class="property">textContent</span>).<span class="title function_">toContain</span>(<span class="string">&#x27;Keyboard&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>那到底什么时候需要使用<code>fixture.whenStable()</code>呢？当你测试的方法里面包含异步操作，但是这个方法又不返回Promise的时候，你就需要使用<code>fixture.whenStable()</code>来等待异步任务完成。</p>
<p>思考题：<br>下面的代码能通过测试吗？</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should update name&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  fixture.<span class="title function_">whenStable</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">expect</span>(<span class="literal">false</span>).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>答案是：能！因为<code>fixture.whenStable()</code>里面的代码根本就没有执行，如何修复？</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should update name&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> fixture.<span class="title function_">whenStable</span>();</span><br><span class="line">  <span class="title function_">expect</span>(<span class="literal">false</span>).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>还可以在<code>fixture.whenStable()</code>前面加上<code>return</code>,因为Jest中如果返回一个Promise，Jest会等待这个Promise执行完成。详情看<a target="_blank" rel="noopener" href="https://zdd.github.io/2024/07/16/jest-test-async-functions/">这里</a></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;should update name&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> fixture.<span class="title function_">whenStable</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">expect</span>(<span class="literal">false</span>).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><h3 id="fixture-detectChanges-1"><a href="#fixture-detectChanges-1" class="headerlink" title="fixture.detectChanges()"></a><code>fixture.detectChanges()</code></h3><ol>
<li>This function will trigger change detection.</li>
<li>Change detection will updates the view.</li>
<li>If you test UI changes, you need to call <code>fixture.detectChanges()</code>.</li>
</ol>
<h3 id="fixture-whenStable-1"><a href="#fixture-whenStable-1" class="headerlink" title="fixture.whenStable()"></a><code>fixture.whenStable()</code></h3><ol>
<li>This function will wait for the asynchronous tasks to complete.</li>
<li>You should use this function in <code>async</code> function.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/02/jest-troubleshooting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/02/jest-troubleshooting/" class="post-title-link" itemprop="url">jest-troubleshooting</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-02 21:15:09" itemprop="dateCreated datePublished" datetime="2024-09-02T21:15:09+08:00">2024-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-29 18:59:02" itemprop="dateModified" datetime="2024-09-29T18:59:02+08:00">2024-09-29</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-TypeError-configSet-processWithEsbuild-is-not-a-function"><a href="#1-TypeError-configSet-processWithEsbuild-is-not-a-function" class="headerlink" title="1. TypeError: configSet.processWithEsbuild is not a function"></a>1. TypeError: configSet.processWithEsbuild is not a function</h2><p>Solution: Update jest.config.js to use <code>jest-angular-preset</code> instead of <code>ts-preset</code>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">transform</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;^.+\\.(ts|js|html)$&#x27;</span>: <span class="string">&#x27;ts-jest&#x27;</span>, <span class="comment">// &lt;-- update this line</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">transform</span>: &#123;</span><br><span class="line">    <span class="string">&#x27;^.+\\.(ts|js|html)$&#x27;</span>: <span class="string">&#x27;jest-preset-angular&#x27;</span>, <span class="comment">// &lt;-- update this line</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="2-SyntaxError-xxx-spec-ts-Missing-semicolon-26-42"><a href="#2-SyntaxError-xxx-spec-ts-Missing-semicolon-26-42" class="headerlink" title="2. SyntaxError: xxx.spec.ts: Missing semicolon. (26:42)"></a>2. SyntaxError: xxx.spec.ts: Missing semicolon. (26:42)</h2><p>Look into the error message, the error occurs on this line.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compiled = fixture.<span class="property">nativeElement</span> <span class="keyword">as</span> <span class="title class_">HTMLElement</span>;</span><br></pre></td></tr></table></figure>
<p>The reason is because <code>as</code>, it’s a keyword in <code>TypeScript</code>, but it’s not a keyword in <code>JavaScript</code>. So the root cause is <code>Jest</code> cannot understand the <code>TypeScript</code> syntax.<br>We need a <code>preset</code> to help <code>Jest</code> to understand <code>TypeScript</code> syntax. The <code>ts-jest</code> is the most popular one. </p>
<ul>
<li>If you project is a pure <code>TypeScript</code> project, see <a target="_blank" rel="noopener" href="https://jestjs.io/docs/getting-started#using-typescript">here</a> on how to config <code>ts-jest</code>.</li>
<li>If you project is an <code>Angular</code> project, Please use <code>jest-preset-angular</code>, see <a target="_blank" rel="noopener" href="https://zdd.github.io/2023/06/07/Angular-Integrate-Jest-to-Angular-App/">here</a> for details.</li>
</ul>
<h2 id="3-jest-failed-to-cache-transform-results-in-xxx-x2F-jest-x2F-jest-transform-cache-map-Failure-message-ENOSPC-no-space-left-on-device-write"><a href="#3-jest-failed-to-cache-transform-results-in-xxx-x2F-jest-x2F-jest-transform-cache-map-Failure-message-ENOSPC-no-space-left-on-device-write" class="headerlink" title="3. jest: failed to cache transform results in: xxx&#x2F;jest&#x2F;jest-transform-cache.map, Failure message: ENOSPC: no space left on device, write"></a>3. jest: failed to cache transform results in: xxx&#x2F;jest&#x2F;jest-transform-cache.map, Failure message: ENOSPC: no space left on device, write</h2><p>This is because Jest is trying to transform itself, so add the following to your <code>jest.config.js</code> file will resolve this issue. see <a target="_blank" rel="noopener" href="https://github.com/jestjs/jest/issues/9503">here</a> for details.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">transformIgnorePatterns</span>: [</span><br><span class="line">    <span class="string">&#x27;&lt;rootDir&gt;/node_modules/@babel&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&lt;rootDir&gt;/node_modules/@jest&#x27;</span>,</span><br><span class="line">  ],</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/24/run-typescript-with-node/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/24/run-typescript-with-node/" class="post-title-link" itemprop="url">run-typescript-with-node</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-08-24 21:01:51 / Modified: 21:06:31" itemprop="dateCreated datePublished" datetime="2024-08-24T21:01:51+08:00">2024-08-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Firstly, <code>node</code> can’t run <code>typescript</code> files directly. You need to compile the <code>typescript</code> files to <code>javascript</code> files and then run them with <code>node</code>.</p>
<p>The following command won’t work!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node ./src/main.ts</span><br></pre></td></tr></table></figure>

<p>You’ll got error like this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(node:13596) Warning: To load an ES module, <span class="built_in">set</span> <span class="string">&quot;type&quot;</span>: <span class="string">&quot;module&quot;</span> <span class="keyword">in</span> the package.json or use the .mjs extension.</span><br><span class="line"></span><br><span class="line">SyntaxError: Cannot use import statement outside a module</span><br></pre></td></tr></table></figure>

<p>How to solve this problem?</p>
<ol>
<li>Use <code>ts-node</code> to run <code>typescript</code> files directly.<ol>
<li><code>npm install -g ts-node</code></li>
<li><code>ts-node ./src/main.ts</code></li>
</ol>
</li>
<li>Use <code>tsc</code> to compile <code>typescript</code> files to <code>javascript</code> files and then run them with <code>node</code>.<ol>
<li><code>npm install -g typescript</code></li>
<li><code>tsc ./src/main.ts</code></li>
<li><code>node ./src/main.js</code></li>
</ol>
</li>
</ol>
<p>Happy coding!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/24/debugging/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/24/debugging/" class="post-title-link" itemprop="url">debugging</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-08-24 16:29:26 / Modified: 17:41:48" itemprop="dateCreated datePublished" datetime="2024-08-24T16:29:26+08:00">2024-08-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This article discuss how to debug Angular&#x2F;Node.js application in WebStorm and VSCode.</p>
<h1 id="Debug-Angular-app"><a href="#Debug-Angular-app" class="headerlink" title="Debug Angular app"></a>Debug Angular app</h1><h2 id="WebStorm"><a href="#WebStorm" class="headerlink" title="WebStorm"></a>WebStorm</h2><ol>
<li>Start angular application<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm start // or ng serve</span><br></pre></td></tr></table></figure></li>
<li>Set breakpoints in the source code in WebStorm Editor.</li>
<li>Press <code>Ctrl + Shift</code> + <code>Click</code> on the URL in the terminal to open the browser.<br><img src="/../images/debug-angular-webstorm.png" alt="debug angular WebStorm"></li>
<li>See <a target="_blank" rel="noopener" href="https://blog.jetbrains.com/webstorm/2017/01/debugging-angular-apps/">here</a> for more details.</li>
</ol>
<h2 id="VSCode"><a href="#VSCode" class="headerlink" title="VSCode"></a>VSCode</h2><h3 id="Launch-with-task-file"><a href="#Launch-with-task-file" class="headerlink" title="Launch with task file"></a>Launch with task file</h3><ol>
<li>Create file <code>launch.json</code> under <code>.vscode</code> folder in project root. <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debug angular app&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chrome&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;preLaunchTask&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm: start&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:4200/&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li>Create file <code>task.json</code> under <code>.vscode</code> folder in project root. <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">// For more information, visit: https://go.microsoft.com/fwlink/?LinkId=733558</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tasks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;script&quot;</span><span class="punctuation">:</span> <span class="string">&quot;start&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;isBackground&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;owner&quot;</span><span class="punctuation">:</span> <span class="string">&quot;typescript&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pattern&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$tsc&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;background&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;activeOnStart&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;beginsPattern&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;(.*?)&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;endsPattern&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;regexp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bundle generation complete&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li>Click <code>Run and Debug</code> in VSCode’s left side menu. &#x2F;&#x2F; number 1 on picture below</li>
<li>Select <code>debug angular app</code> in the dropdown list. &#x2F;&#x2F; number 2 on picture below</li>
<li>Click the Debug icon or Press <code>F5</code> to start debugging. &#x2F;&#x2F; number 3 on picture below<br><img src="/../images/debug-angular-vscode.png" alt="debug angular VSCode"><br>In this way, VSCode will open a new Chrome window and you can debug the Angular app in VSCode.</li>
</ol>
<h3 id="Launch-without-task-file"><a href="#Launch-without-task-file" class="headerlink" title="Launch without task file"></a>Launch without task file</h3><p>If you don’t want to use <code>task.json</code> file, you can remove it and delete <code>preLaunchTask</code> in <code>launch.json</code> file. Then </p>
<ol>
<li>Manually start the Angular app by <code>npm start</code> in terminal.</li>
<li>Click the Debug icon or Press <code>F5</code> to start debugging in VSCode.<br>In this way you need to manually open the browser and navigate to <code>http://localhost:4200/</code> to debug the Angular app.</li>
</ol>
<h2 id="Browser"><a href="#Browser" class="headerlink" title="Browser"></a>Browser</h2><p>No matter you use WebStorm or VSCode, you can also debug Angular app in browser.</p>
<ol>
<li>Run your angular app by <code>npm run start</code> or <code>ng serve</code></li>
<li>Open the browser and navigate to <code>http://localhost:4200/</code>.</li>
<li>Press <code>F12</code> to open the developer tools and switch to <code>Source</code> tab.</li>
<li>Set breakpoint in your source code in browser. see <a target="_blank" rel="noopener" href="https://zdd.github.io/2024/02/18/javascript-debugging/">here</a> for more details.<ol>
<li>If you use webpack, the source file was in <code>webpack://src</code> folder.</li>
<li>If you use ESBuild + Vite, the source files were in <code>src</code> folder.</li>
</ol>
</li>
<li>Refresh the page to trigger the breakpoints.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/22/error-ng8001-xxx-is-not-a-known-element/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/22/error-ng8001-xxx-is-not-a-known-element/" class="post-title-link" itemprop="url">[ERROR] NG8001: 'xxx' is not a known element</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-08-22 20:43:16" itemprop="dateCreated datePublished" datetime="2024-08-22T20:43:16+08:00">2024-08-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-08-24 16:12:25" itemprop="dateModified" datetime="2024-08-24T16:12:25+08:00">2024-08-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This is a very common error when you are working with Angular, today, I will give a special case of this error.</p>
<p>I have the following code in my app.</p>
<ol>
<li>ProductHomeModule -&gt; ProductHomeComponent</li>
<li>ProductDetailModule -&gt; ProductDetailComponent</li>
<li>App router contains the following routes:<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-routing.module.ts</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Routes</span> = [</span><br><span class="line">   &#123; <span class="attr">path</span>: <span class="string">&#x27;product&#x27;</span>, <span class="attr">component</span>: <span class="title class_">ProductHomeComponent</span> &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
When I build my app, I got the following error:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR <span class="keyword">in</span> src/app/product-home/product-home.component.html:1:1 - error NG8001: <span class="string">&#x27;app-product-detail&#x27;</span> is not a known element:</span><br></pre></td></tr></table></figure></li>
</ol>
<p>But If I remove the router for <code>product</code>, the error is gone, why?<br>Because, I use <code>ProductHomeComponent</code> in <code>app-routing.module.ts</code> which in turn was used in file <code>app.module.ts</code>, But, when Angular compile template for <code>ProductHomeComponent</code>, it didn’t know where to find <code>ProductDetailComponent</code>. to solve this, import <code>ProductHomeModule</code> in <code>app.module.ts</code> like this:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imports</span>: [</span><br><span class="line">   <span class="title class_">ProductHomeModule</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>Then the error is gone. Because, ProductHomeModule has imports <code>ProductDetailModule</code>, so Angular knows where to find <code>ProductDetailComponent</code>.</p>
<p>Conclusion:<br>If you wan to use a component from another module, you need to import the module which contains the component in the module where you use the component. You may use the component by selector in templates or in the router, both need to import the module which contains the component.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/18/angular-ssr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/18/angular-ssr/" class="post-title-link" itemprop="url">angular-ssr</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-08-18 20:56:05" itemprop="dateCreated datePublished" datetime="2024-08-18T20:56:05+08:00">2024-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-14 21:16:23" itemprop="dateModified" datetime="2024-11-14T21:16:23+08:00">2024-11-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Angular-Server-Side-Rendering-For-New-Project"><a href="#Angular-Server-Side-Rendering-For-New-Project" class="headerlink" title="Angular Server Side Rendering For New Project"></a>Angular Server Side Rendering For New Project</h1><h2 id="Step-by-step-guide"><a href="#Step-by-step-guide" class="headerlink" title="Step by step guide"></a>Step by step guide</h2><p>Start from Angular 17, SSR was enabled by default when you create a new Angular project. To create a new Angular project, run the following command.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng new angular-ssr</span><br></pre></td></tr></table></figure>
<p>Press <code>Y</code> on keyboard when prompted with the following question, then Angular will generate the boilerplate code for you.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Do you want to <span class="built_in">enable</span> Server-Side Rendering (SSR) and Static Site Generation (SSG/Prerendering)? (y/N)</span><br></pre></td></tr></table></figure>
<p>Compared with the traditional pure client-side rendering project, the Angular SSR project has the following differences:</p>
<h2 id="Project-structure-changes-for-SSR"><a href="#Project-structure-changes-for-SSR" class="headerlink" title="Project structure changes for SSR"></a>Project structure changes for SSR</h2><p>The following new files were added to the project:</p>
<ol>
<li>The <code>server.ts</code> file is added to the project root directory.</li>
<li>The <code>src/main.server.ts</code> file is added to the project source directory.</li>
<li>The <code>src/app/app.config.server.ts</code> file is added to the project source directory.</li>
</ol>
<p>The following changes were made to the existing files:</p>
<ol>
<li>The <code>package.json</code> file has a new <code>server</code> script.<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line">   <span class="attr">&quot;serve:ssr:angular-ssr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;node dist/angular-ssr/server/server.mjs&quot;</span> <span class="comment">// &lt;--- new</span></span><br><span class="line"> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure></li>
<li>The <code>angular.json</code> file has a new <code>server</code> configuration under the <code>architect | build | options</code> section.<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;src/main.server.ts&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;prerender&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ssr&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;entry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;server.ts&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure></li>
<li>The <code>tsconfig.app.json</code> file <code>file</code> section is updated to include the <code>src/main.server.ts</code> file.<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"> <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">   <span class="string">&quot;src/main.ts&quot;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="string">&quot;src/main.server.ts&quot;</span><span class="punctuation">,</span> <span class="comment">// &lt;--- new</span></span><br><span class="line">   <span class="string">&quot;server.ts&quot;</span> <span class="comment">// &lt;--- new</span></span><br><span class="line"> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li>The <code>src/app/app.config.ts</code> file add <code>provideClientHydration</code> in <code>providers</code>.<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">appConfig</span>: <span class="title class_">ApplicationConfig</span> = &#123;</span><br><span class="line">   <span class="attr">providers</span>: [<span class="title function_">provideRouter</span>(routes), <span class="title function_">provideClientHydration</span>()]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="Run-app"><a href="#Run-app" class="headerlink" title="Run app"></a>Run app</h2><h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><h2 id="How-to-check-if-page-is-rendered-by-server-or-client"><a href="#How-to-check-if-page-is-rendered-by-server-or-client" class="headerlink" title="How to check if page is rendered by server or client"></a>How to check if page is rendered by server or client</h2><ol>
<li>Open the page in Chrome browser.</li>
<li>Right-click on the page and select <code>View page source</code>.</li>
<li>Check the body tag, if the body tag is empty, it means the page is rendered in client side, the following page is a CSR page, since the body tag only contains <code>&lt;app-root&gt;&lt;/app-root&gt;</code>. that’s for the client side rendering.<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/@vite/client&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">title</span>&gt;</span>Angular SSR In Depth<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;icon&quot;</span> <span class="attr">type</span>=<span class="string">&quot;image/x-icon&quot;</span> <span class="attr">href</span>=<span class="string">&quot;favicon.ico&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;https://fonts.googleapis.com/css?family=Roboto:300,400,500<span class="symbol">&amp;amp;</span> display=swap&quot;</span>   <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;https://fonts.googleapis.com/icon?family=Material+Icons&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;styles.css&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">&quot;mat-typography&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">app-root</span>&gt;</span><span class="tag">&lt;/<span class="name">app-root</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;polyfills.js&quot;</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;main.js&quot;</span>    <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript">&lt;<span class="regexp">/  script&gt;&lt;/</span>body&gt;</span></span><br><span class="line"><span class="language-javascript">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="Angular-SSR-for-existing-project"><a href="#Angular-SSR-for-existing-project" class="headerlink" title="Angular SSR for existing project"></a>Angular SSR for existing project</h1><p>If you have an existing project and want to enable SSR, you can follow the steps below.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng add @angular/ssr</span><br></pre></td></tr></table></figure>
<p>This command will add the necessary files and configurations to your project to enable SSR.</p>
<ol>
<li><p>Create <code>src/main.server.ts</code> file.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; bootstrapApplication &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/platform-browser&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app/app.component&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; config &#125; <span class="keyword">from</span> <span class="string">&#x27;./app/app.config.server&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">bootstrap</span> = (<span class="params"></span>) =&gt; <span class="title function_">bootstrapApplication</span>(<span class="title class_">AppComponent</span>, config);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> bootstrap;</span><br></pre></td></tr></table></figure></li>
<li><p>Create <code>src/app/app.config.server.ts</code> file.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mergeApplicationConfig, <span class="title class_">ApplicationConfig</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; provideServerRendering &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/platform-server&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; appConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.config&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">serverConfig</span>: <span class="title class_">ApplicationConfig</span> = &#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    <span class="title function_">provideServerRendering</span>()</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> config = <span class="title function_">mergeApplicationConfig</span>(appConfig, serverConfig);</span><br></pre></td></tr></table></figure></li>
<li><p>Create <code>server.ts</code> file.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">APP_BASE_HREF</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">CommonEngine</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/ssr&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; fileURLToPath &#125; <span class="keyword">from</span> <span class="string">&#x27;node:url&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; dirname, join, resolve &#125; <span class="keyword">from</span> <span class="string">&#x27;node:path&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> bootstrap <span class="keyword">from</span> <span class="string">&#x27;./src/main.server&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The Express app is exported so that it can be used by serverless Functions.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">app</span>(<span class="params"></span>): express.<span class="property">Express</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> server = <span class="title function_">express</span>();</span><br><span class="line">  <span class="keyword">const</span> serverDistFolder = <span class="title function_">dirname</span>(<span class="title function_">fileURLToPath</span>(<span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">url</span>));</span><br><span class="line">  <span class="keyword">const</span> browserDistFolder = <span class="title function_">resolve</span>(serverDistFolder, <span class="string">&#x27;../browser&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> indexHtml = <span class="title function_">join</span>(serverDistFolder, <span class="string">&#x27;index.server.html&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> commonEngine = <span class="keyword">new</span> <span class="title class_">CommonEngine</span>();</span><br><span class="line"></span><br><span class="line">  server.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  server.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, browserDistFolder);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Example Express Rest API endpoints</span></span><br><span class="line">  <span class="comment">// server.get(&#x27;/api/**&#x27;, (req, res) =&gt; &#123; &#125;);</span></span><br><span class="line">  <span class="comment">// Serve static files from /browser</span></span><br><span class="line">  server.<span class="title function_">get</span>(<span class="string">&#x27;**&#x27;</span>, express.<span class="title function_">static</span>(browserDistFolder, &#123;</span><br><span class="line">    <span class="attr">maxAge</span>: <span class="string">&#x27;1y&#x27;</span>,</span><br><span class="line">    <span class="attr">index</span>: <span class="string">&#x27;index.html&#x27;</span>,</span><br><span class="line">  &#125;));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// All regular routes use the Angular engine</span></span><br><span class="line">  server.<span class="title function_">get</span>(<span class="string">&#x27;**&#x27;</span>, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; protocol, originalUrl, baseUrl, headers &#125; = req;</span><br><span class="line">    commonEngine</span><br><span class="line">      .<span class="title function_">render</span>(&#123;</span><br><span class="line">        bootstrap,</span><br><span class="line">        <span class="attr">documentFilePath</span>: indexHtml,</span><br><span class="line">        <span class="attr">url</span>: <span class="string">`<span class="subst">$&#123;protocol&#125;</span>://<span class="subst">$&#123;headers.host&#125;</span><span class="subst">$&#123;originalUrl&#125;</span>`</span>,</span><br><span class="line">        <span class="attr">publicPath</span>: browserDistFolder,</span><br><span class="line">        <span class="attr">providers</span>: [&#123; <span class="attr">provide</span>: <span class="variable constant_">APP_BASE_HREF</span>, <span class="attr">useValue</span>: baseUrl &#125;],</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">(<span class="params">html</span>) =&gt;</span> res.<span class="title function_">send</span>(html))</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="title function_">next</span>(err));</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> server;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">run</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> port = process.<span class="property">env</span>[<span class="string">&#x27;PORT&#x27;</span>] || <span class="number">4000</span>;</span><br><span class="line">  <span class="comment">// Start up the Node server</span></span><br><span class="line">  <span class="keyword">const</span> server = <span class="title function_">app</span>();</span><br><span class="line">  server.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Node Express server listening on http://localhost:<span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">run</span>();</span><br></pre></td></tr></table></figure></li>
<li><p>Update <code>angular.json</code> file. </p>
<p>Add the following in <code>architect | build | options</code> section.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;src/main.server.ts&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;prerender&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;ssr&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;entry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;server.ts&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li><p>Update <code>tsconfig.app.json</code> file.</p>
</li>
<li><p>Update <code>src/app/app.config.ts</code> file.</p>
</li>
<li><p>Update <code>package.json</code> file.</p>
</li>
</ol>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=U1MP4uCuUVI">https://www.youtube.com/watch?v=U1MP4uCuUVI</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/12/angular-di-define-dependency-providers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/12/angular-di-define-dependency-providers/" class="post-title-link" itemprop="url">angular-di-define-dependency-providers</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-08-12 20:09:07 / Modified: 20:10:26" itemprop="dateCreated datePublished" datetime="2024-08-12T20:09:07+08:00">2024-08-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>There are many ways to define a dependency provider in Angular. In this article, we will discuss the following ways:</p>
<h1 id="useClass"><a href="#useClass" class="headerlink" title="useClass"></a>useClass</h1><h1 id="useFactory"><a href="#useFactory" class="headerlink" title="useFactory"></a>useFactory</h1><h1 id="useExisting"><a href="#useExisting" class="headerlink" title="useExisting"></a>useExisting</h1><h1 id="useValue"><a href="#useValue" class="headerlink" title="useValue"></a>useValue</h1><h2 id="InjectionToken"><a href="#InjectionToken" class="headerlink" title="InjectionToken"></a>InjectionToken</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Philip Zhang</p>
  <div class="site-description" itemprop="description">青春都一餉，忍把浮名換了代碼輕狂。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">217</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">300</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Philip Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
