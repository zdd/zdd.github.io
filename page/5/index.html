<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
<meta property="og:type" content="website">
<meta property="og:title" content="Philip">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Philip">
<meta property="og:description" content="青春都一餉，忍把浮名換了代碼輕狂。">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Philip Zhang">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Philip</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Philip</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Philip's blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/28/npm-install-production/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/28/npm-install-production/" class="post-title-link" itemprop="url">npm-install-production</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-28 12:37:23 / Modified: 12:38:13" itemprop="dateCreated datePublished" datetime="2024-09-28T12:37:23+08:00">2024-09-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>The <code>npm install --production</code> command is used to install only the dependencies listed under the <code>dependencies</code> section in the <code>package.json</code> file, excluding the <code>devDependencies</code>. This is typically used in production environments where you want to avoid installing unnecessary development tools and libraries.</p>
<p>Here is a brief explanation of when and why you might use <code>npm install --production</code>:</p>
<ol>
<li><p><strong>Production Deployment</strong>: When deploying an application to a production environment, you often want to minimize the size of the deployment package and reduce the number of installed packages to only those necessary for running the application. This helps in improving performance and security.</p>
</li>
<li><p><strong>Server Environments</strong>: In server environments where the application is running, you generally do not need development tools like testing frameworks, linters, or build tools. Using <code>npm install --production</code> ensures that only the essential packages are installed.</p>
</li>
<li><p><strong>Docker Images</strong>: When building Docker images for your application, using <code>npm install --production</code> can help create smaller and more efficient images by excluding development dependencies.</p>
</li>
</ol>
<p>Example usage:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --production</span><br></pre></td></tr></table></figure>

<p>This command will read the <code>package.json</code> file and install only the packages listed under <code>dependencies</code>, ignoring those under <code>devDependencies</code>.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/28/rxjs-function-timeout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/28/rxjs-function-timeout/" class="post-title-link" itemprop="url">rxjs-function-timeout</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-28 12:11:46 / Modified: 12:37:05" itemprop="dateCreated datePublished" datetime="2024-09-28T12:11:46+08:00">2024-09-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In <code>RxJS</code>, there is a <a target="_blank" rel="noopener" href="https://rxjs.dev/api/index/function/timeout"><code>timeout</code></a> operator, it’s used to throw an error if the source observable does not emit a value within a specified timeout duration.</p>
<h2 id="Use-case"><a href="#Use-case" class="headerlink" title="Use case"></a>Use case</h2><p>In Angular, the HttpClient service is used to make HTTP requests. Sometimes, we want to set a timeout for the request, if the request does not complete within the specified time, we want to cancel the request and show an error message to the user.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpClient</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; catchError, timeout &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; throwError &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">providedIn</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ApiService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> http: HttpClient</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">get</span>(<span class="string">&#x27;https://example.com/api/data&#x27;</span>).<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">timeout</span>(<span class="number">10000</span>), <span class="comment">// 10 seconds</span></span><br><span class="line">      <span class="title function_">catchError</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// Handle timeout or other errors</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Request timed out or failed&#x27;</span>, error);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">throwError</span>(error);</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>But, wait, what if I want to add this timeout for all my requests? Do I need to add the <code>timeout</code> operator to every request? The answer is no, you can create an interceptor to add the <code>timeout</code> operator to all requests.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">HttpEvent</span>,</span><br><span class="line">  <span class="title class_">HttpHandler</span>,</span><br><span class="line">  <span class="title class_">HttpInterceptor</span>,</span><br><span class="line">  <span class="title class_">HttpRequest</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; timeout &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs/operators&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">DEFAULT_TIMEOUT</span> = <span class="keyword">new</span> <span class="title class_">InjectionToken</span>&lt;<span class="built_in">number</span>&gt;(<span class="string">&#x27;defaultTimeout&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">TimeoutInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HttpInterceptor</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="meta">@Inject</span>(DEFAULT_TIMEOUT) <span class="keyword">protected</span> defaultTimeout: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">intercept</span>(</span><br><span class="line">    <span class="attr">req</span>: <span class="title class_">HttpRequest</span>&lt;<span class="built_in">any</span>&gt;,</span><br><span class="line">    <span class="attr">next</span>: <span class="title class_">HttpHandler</span></span><br><span class="line">  ): <span class="title class_">Observable</span>&lt;<span class="title class_">HttpEvent</span>&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> next.<span class="title function_">handle</span>(req).<span class="title function_">pipe</span>(<span class="title function_">timeout</span>(<span class="variable language_">this</span>.<span class="property">defaultTimeout</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Don’t forget to add the interceptor to the providers array in the <code>AppModule</code>.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">HTTP_INTERCEPTORS</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">TimeoutInterceptor</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./timeout.interceptor&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="variable constant_">HTTP_INTERCEPTORS</span>,</span><br><span class="line">      <span class="attr">useClass</span>: <span class="title class_">TimeoutInterceptor</span>,</span><br><span class="line">      <span class="attr">multi</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">provide</span>: <span class="variable constant_">DEFAULT_TIMEOUT</span>, <span class="attr">useValue</span>: <span class="number">30000</span> &#125;</span><br><span class="line">  ],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>Now, all your HTTP requests will have a timeout of 10 seconds.</p>
<p>But, what if I want to set different timeout values for some specific requests? You can add a custom header to the request and check it in the interceptor, if custom header <code>timeout</code> exists, use the custom timeout value, otherwise use the default timeout value.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">HttpEvent</span>,</span><br><span class="line">  <span class="title class_">HttpHandler</span>,</span><br><span class="line">  <span class="title class_">HttpInterceptor</span>,</span><br><span class="line">  <span class="title class_">HttpRequest</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Observable</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">TimeoutInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HttpInterceptor</span> &#123;</span><br><span class="line">  <span class="title function_">intercept</span>(</span><br><span class="line">    <span class="attr">req</span>: <span class="title class_">HttpRequest</span>&lt;<span class="built_in">any</span>&gt;,</span><br><span class="line">    <span class="attr">next</span>: <span class="title class_">HttpHandler</span></span><br><span class="line">  ): <span class="title class_">Observable</span>&lt;<span class="title class_">HttpEvent</span>&lt;<span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> timeoutValue = req.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&#x27;timeout&#x27;</span>) || <span class="variable language_">this</span>.<span class="property">defaultTimeout</span>;</span><br><span class="line">    <span class="keyword">const</span> timeoutValueNumeric = <span class="title class_">Number</span>(timeoutValue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next.<span class="title function_">handle</span>(req).<span class="title function_">pipe</span>(<span class="title function_">timeout</span>(timeoutValueNumeric));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, you can set the timeout value in the request headers.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HttpHeaders</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/common/http&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> headers = <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>().<span class="title function_">set</span>(<span class="string">&#x27;timeout&#x27;</span>, <span class="string">&#x27;5000&#x27;</span>); <span class="comment">// 5 seconds</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">http</span>.<span class="title function_">get</span>(<span class="string">&#x27;https://example.com/api/data&#x27;</span>, &#123; headers &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://rxjs.dev/api/index/function/timeout">https://rxjs.dev/api/index/function/timeout</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/45938931/default-and-specific-request-timeout">https://stackoverflow.com/questions/45938931/default-and-specific-request-timeout</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/20/jest-mockxxxonce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/20/jest-mockxxxonce/" class="post-title-link" itemprop="url">jest-mockXXXOnce</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-20 19:24:41 / Modified: 19:52:04" itemprop="dateCreated datePublished" datetime="2024-09-20T19:24:41+08:00">2024-09-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>There are lots of mockXXXOnce functions in Jest API, for example:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://jestjs.io/docs/mock-function-api#mockfnmockimplementationoncefn">mockImplementationOnce</a></li>
<li><a target="_blank" rel="noopener" href="https://jestjs.io/docs/mock-function-api#mockfnmockreturnvalueoncevalue">mockReturnValueOnce</a></li>
<li><a target="_blank" rel="noopener" href="https://jestjs.io/docs/mock-function-api#mockfnmockresolvedvalueoncevalue">mockResolvedValueOnce</a></li>
</ul>
<p>These functions are only mocked on the first call, all the subsequent calls will use the original implementations or return the original values.</p>
<p>Be careful when using such functions, it may not be what you want, take the following code as example:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span> &#123;</span><br><span class="line">  title = <span class="string">&#x27;jest-demo&#x27;</span>;</span><br><span class="line">  lastTime = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">getIdleTime</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Date</span>.<span class="title function_">now</span>() - <span class="variable language_">this</span>.<span class="property">lastTime</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">getDuration</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">getIdleTime</span>() &gt; <span class="number">5</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;5+ hours&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="title function_">getIdleTime</span>() &gt;= <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;1 ~ 5 hours&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;in an hour&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here are the test codes, the first one pass test, but the second one will failed. Do you know why?</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">`should return 5+ hours`</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> fixture = <span class="title class_">TestBed</span>.<span class="title function_">createComponent</span>(<span class="title class_">AppComponent</span>);</span><br><span class="line">  <span class="keyword">const</span> component = fixture.<span class="property">componentInstance</span>;</span><br><span class="line">  jest.<span class="title function_">spyOn</span>(component, <span class="string">&#x27;getIdleTime&#x27;</span>).<span class="title function_">mockImplementationOnce</span>(<span class="function">() =&gt;</span> <span class="number">6</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">  <span class="title function_">expect</span>(component.<span class="title function_">getDuration</span>()).<span class="title function_">toBe</span>(<span class="string">&#x27;5+ hours&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title function_">it</span>(<span class="string">`should return 1 ~ 5 hours`</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> fixture = <span class="title class_">TestBed</span>.<span class="title function_">createComponent</span>(<span class="title class_">AppComponent</span>);</span><br><span class="line">  <span class="keyword">const</span> component = fixture.<span class="property">componentInstance</span>;</span><br><span class="line">  jest.<span class="title function_">spyOn</span>(component, <span class="string">&#x27;getIdleTime&#x27;</span>).<span class="title function_">mockImplementationOnce</span>(<span class="function">() =&gt;</span> <span class="number">4</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>);</span><br><span class="line">  <span class="title function_">expect</span>(component.<span class="title function_">getDuration</span>()).<span class="title function_">toBe</span>(<span class="string">&#x27;1 ~ 5 hours&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Because the first test case only reach the first <code>if</code> branch in <code>getDuration</code> function, it only call <code>getIdleTime</code> once. So there is no problem.</p>
<p>But the second test case need to reach the second <code>if</code> branch in <code>getDuration</code> function, but the mock only take effect in the first if branch, the second branch will still use the original implementation of <code>getIdleTime</code> function, so the test failed.</p>
<p>To fix this issue, you can use <code>mockImplementation</code> instead of <code>mockImplementationOnce</code> in the second test case.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/19/nx-library-types/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/19/nx-library-types/" class="post-title-link" itemprop="url">nx-library-types</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-19 09:40:06 / Modified: 09:48:51" itemprop="dateCreated datePublished" datetime="2024-09-19T09:40:06+08:00">2024-09-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Nx-Library-Types-by-functionality"><a href="#Nx-Library-Types-by-functionality" class="headerlink" title="Nx Library Types by functionality"></a>Nx Library Types by functionality</h2><h3 id="Feature-library"><a href="#Feature-library" class="headerlink" title="Feature library"></a>Feature library</h3><h3 id="UI-library"><a href="#UI-library" class="headerlink" title="UI library"></a>UI library</h3><h3 id="Data-access-library"><a href="#Data-access-library" class="headerlink" title="Data access library"></a>Data access library</h3><h3 id="Utility-library"><a href="#Utility-library" class="headerlink" title="Utility library"></a>Utility library</h3><h2 id="Nx-library-types-by-buildable-and-publishable"><a href="#Nx-library-types-by-buildable-and-publishable" class="headerlink" title="Nx library types by buildable and publishable"></a>Nx library types by buildable and publishable</h2><h3 id="Workspace-library-Normal-library"><a href="#Workspace-library-Normal-library" class="headerlink" title="Workspace library(Normal library)"></a>Workspace library(Normal library)</h3><p>Create without any options, it’s a normal library.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nx g @nx/angular:lib libName</span><br></pre></td></tr></table></figure>
<ul>
<li>No <code>ng-packagr</code> file generated.</li>
<li>No <code>package.json</code> file generated .</li>
<li>No <code>targets/build</code> section in <code>project.json</code> file.</li>
</ul>
<h3 id="Buildable-library"><a href="#Buildable-library" class="headerlink" title="Buildable library"></a>Buildable library</h3><p>Create by adding <code>buildable</code> option.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nx g @nx/angular:lib libName --buildable</span><br></pre></td></tr></table></figure>
<ul>
<li>Add <code>ng-packagr</code> file to root of the library.</li>
<li>Add <code>package.json</code> file to root of the library.</li>
<li><code>name</code> property in <code>package.json</code> is the <code>libName</code>.</li>
<li>Add <code>targets/build</code> section in <code>project.json</code> file.</li>
<li>Executor of build is: <code>&quot;executor&quot;: &quot;@nx/angular:ng-packagr-lite&quot;</code></li>
</ul>
<h3 id="Publishable-library"><a href="#Publishable-library" class="headerlink" title="Publishable library"></a>Publishable library</h3><p>Create by adding <code>publishable</code> and <code>importPath</code> option. <code>importPath</code> is the path that the library will be imported from, will be used as name of the package.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nx g @nx/angular:lib libName --publishable --importPath=@myorg/libName</span><br></pre></td></tr></table></figure>
<ul>
<li>Add <code>ng-packagr</code> file to root of the library.</li>
<li>Add <code>package.json</code> file to root of the library.</li>
<li><code>name</code> property in <code>package.json</code> is the <code>importPath</code>.</li>
<li>Add <code>targets/build</code> section in <code>project.json</code> file.</li>
<li>Executor of build is: <code>&quot;executor&quot;: &quot;@nx/angular:package&quot;</code></li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nx.dev/concepts/decisions/project-dependency-rules">https://nx.dev/concepts/decisions/project-dependency-rules</a></li>
<li><a target="_blank" rel="noopener" href="https://nx.dev/concepts/buildable-and-publishable-libraries">https://nx.dev/concepts/buildable-and-publishable-libraries</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/19/angular-troubleshooting-rootdir/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/19/angular-troubleshooting-rootdir/" class="post-title-link" itemprop="url">typescript-troubleshooting-rootDir</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-19 08:44:53 / Modified: 09:06:51" itemprop="dateCreated datePublished" datetime="2024-09-19T08:44:53+08:00">2024-09-19</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>今天在做一个 Angular 项目的时候，遇到了一个问题：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR <span class="keyword">in</span> src/app/app.module.ts:1:1 - error TS6059: File <span class="string">&#x27;xxx&#x27;</span> is not under <span class="string">&#x27;rootDir&#x27;</span> <span class="string">&#x27;yyy&#x27;</span>. <span class="string">&#x27;rootDir&#x27;</span> is expected to contain all <span class="built_in">source</span> files.</span><br></pre></td></tr></table></figure>

<p>可以看到这个错误是关于<code>rootDir</code>的，那么<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/tsconfig/rootDir.html"><code>rootDir</code></a>是什么呢？看一下官网的解释：</p>
<p>Default: The longest common path of all non-declaration input files. If composite is set, the default is instead the directory containing the tsconfig.json file.</p>
<p>When TypeScript compiles files, it keeps the same directory structure in the output directory as exists in the input directory.</p>
<p>For example, let’s say you have some input files:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MyProj</span><br><span class="line">├── tsconfig.json</span><br><span class="line">├── core</span><br><span class="line">│   ├── a.ts</span><br><span class="line">│   ├── b.ts</span><br><span class="line">│   ├── sub</span><br><span class="line">│   │   ├── c.ts</span><br><span class="line">├── types.d.ts</span><br></pre></td></tr></table></figure>

<p>The inferred value for rootDir is the longest common path of all non-declaration input files, which in this case is core&#x2F;.</p>
<p>If your outDir was dist, TypeScript would write this tree:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MyProj</span><br><span class="line">├── dist</span><br><span class="line">│   ├── a.js</span><br><span class="line">│   ├── b.js</span><br><span class="line">│   ├── sub</span><br><span class="line">│   │   ├── c.js</span><br></pre></td></tr></table></figure>

<p>Importantly, <strong><code>rootDir does not affect which files become part of the compilation. It has no interaction with the include, exclude, or files tsconfig.json settings.</code></strong></p>
<p>Note that TypeScript will never write an output file to a directory outside of outDir, and will never skip emitting a file. For this reason, <code>rootDir also enforces that all files which need to be emitted are underneath the rootDir path.</code></p>
<p>重点看这句：<code>rootDir also enforces that all files which need to be emitted are underneath the rootDir path.</code> 也就是说，所有需要被编译的文件都必须在<code>rootDir</code>的路径下，否则就会报错。</p>
<p>For example, let’s say you had this tree: 如果我们在<code>tsconfig.json</code>中指定了<code>rootDir</code>为<code>core</code>，那么<code>helpers.ts</code>就不在<code>rootDir</code>的路径下，所以会报错。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MyProj</span><br><span class="line">├── tsconfig.json</span><br><span class="line">├── core</span><br><span class="line">│   ├── a.ts</span><br><span class="line">│   ├── b.ts</span><br><span class="line">├── helpers.ts</span><br></pre></td></tr></table></figure>

<h2 id="Nx-based-mono-repos"><a href="#Nx-based-mono-repos" class="headerlink" title="Nx based mono-repos."></a>Nx based mono-repos.</h2><p>如果是基于Nx的但一代码仓库，有时候也会出现这个错误，原因是一个Publishable的lib引用了另一个Non-Publishable的lib，这时候就会报错。详情请看<a target="_blank" rel="noopener" href="https://stackoverflow.com/a/76500288/1487475">这里</a>, 关于Nx buildable&#x2F;publishable libraries, please see <a target="_blank" rel="noopener" href="https://nx.dev/concepts/buildable-and-publishable-libraries">here</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/18/misc-2024-09/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/18/misc-2024-09/" class="post-title-link" itemprop="url">misc-2024-09</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-18 21:39:29" itemprop="dateCreated datePublished" datetime="2024-09-18T21:39:29+08:00">2024-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-19 21:33:04" itemprop="dateModified" datetime="2024-11-19T21:33:04+08:00">2024-11-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li><code>ngc</code> - Angular compiler</li>
<li><code>ngcc</code> - Angular compatible compiler</li>
<li>. <code>fems</code> - <a target="_blank" rel="noopener" href="https://docs.google.com/document/d/1CZC2rcpxffTDfRDs6p1cfbmKNLA6x5O-NtkJglDaBVs/edit?pli=1#heading=h.k0mh3o8u5hx">Flattened ES Module</a>, this is the angular file format for ES Module.</li>
<li>AOT - <a target="_blank" rel="noopener" href="https://angular.dev/tools/cli/aot-compiler">Ahead of Time Compilation</a></li>
<li>JIT - <a target="_blank" rel="noopener" href="https://radheradhepawan.medium.com/what-is-aot-and-jit-ivy-and-v8-how-work-together-in-angular-f54f3efb8a5f">Just in Time Compilation</a></li>
<li><code>ng add</code> vs <code>npm install</code> - <code>ng add</code> is a schematic that can install packages and run additional code to set up the package. <code>npm install</code> is just installing the package.</li>
<li>Angular HttpClient底层是基于HttpXMLRequest和Jsonp的，所以可以使用<code>XMLHttpRequest</code>的所有方法。</li>
<li>HostBinding - Angular Decorator that declares a DOM property to bind to. is equivalent to [property]&#x3D;”expression”.</li>
<li>Angular如何处理scss文件的？package.json中并没有安装sass对应的包。难道是Angular CLI内置了sass的编译器，所以不需要安装sass包？</li>
<li>:ng-deep和:host如何配合使用</li>
<li>Angular中的ViewEncapsulation是如何实现的？有哪三种封装模式？</li>
<li>Reload page on same url with different parameters<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">appConfig</span>: <span class="title class_">ApplicationConfig</span> = &#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    <span class="title function_">provideRouter</span>(</span><br><span class="line">      appRoutes,</span><br><span class="line">      <span class="title function_">withRouterConfig</span>(&#123; <span class="attr">onSameUrlNavigation</span>: <span class="string">&#x27;reload&#x27;</span> &#125;)</span><br><span class="line">    ),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li>如何使用Native Federation?</li>
<li>How to mock service in Unit test(Jest) in Angular? <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/79071748/mock-provided-service-in-standalone-component-in-jest-unit-test">https://stackoverflow.com/questions/79071748/mock-provided-service-in-standalone-component-in-jest-unit-test</a></li>
<li>这种怎么测试？添加到Jest异步测试中。<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dataService</span>.<span class="title function_">fetchData</span>().<span class="title function_">subscribe</span>(<span class="function">(<span class="params">data: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">products</span> = data;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Generate module based component after Angular 17.<br>Start from Angular 17, Angular CLI use standalone component by default, however, you can still generate module based application with the following command.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng g app my-app --standalone=<span class="literal">false</span></span><br></pre></td></tr></table></figure></li>
<li>Why Angular use <code>Decorator</code> instead of <code>Abstract Class</code> for <code>Component</code> and <code>Service</code>?</li>
<li>Android No matching client found for package name ‘com.jiyuzhai.caoquanbei’, update package name in file app&#x2F;src&#x2F;google-services.json to match your application id.</li>
<li>一个Angular文件内可以定义多个组件。</li>
<li>Event loop and browser rendering是如何交互的，也就是Browser rendering是在Event loop哪个阶段进行的？</li>
<li>NW.js和Electron类似，都是用来开发跨平台桌面应用的框架。</li>
<li>Traceur和Babel都是用来将ES6+代码转换为ES5代码的工具。Traceur是Google开发的，Babel是社区开发的。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/18/typescript-tsc-guide/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/18/typescript-tsc-guide/" class="post-title-link" itemprop="url">typescript-tsc-guide</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-18 21:22:00" itemprop="dateCreated datePublished" datetime="2024-09-18T21:22:00+08:00">2024-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 10:23:52" itemprop="dateModified" datetime="2024-09-19T10:23:52+08:00">2024-09-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Install-TypeScript"><a href="#Install-TypeScript" class="headerlink" title="Install TypeScript"></a>Install TypeScript</h2><p>This directive will install TypeScript globally.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g typescript</span><br></pre></td></tr></table></figure>

<h2 id="Init-TypeScript-project"><a href="#Init-TypeScript-project" class="headerlink" title="Init TypeScript project"></a>Init TypeScript project</h2><p>This step will create a <code>tsconfig.json</code> file in under <code>typescript-tsc-guide</code> folder.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> typescript-tsc-guide</span><br><span class="line"><span class="built_in">cd</span> typescript-tsc-guide</span><br><span class="line">tsc --init <span class="comment"># create tsconfig.json file</span></span><br></pre></td></tr></table></figure>

<h2 id="Create-typescript-files"><a href="#Create-typescript-files" class="headerlink" title="Create typescript files"></a>Create typescript files</h2><p>Create a folder <code>src</code> under current folder. Then create a file <code>index.ts</code> under <code>src</code> folder.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> src</span><br><span class="line"><span class="built_in">touch</span> src/index.ts</span><br></pre></td></tr></table></figure>

<p>input the following code to <code>src/index.ts</code> file.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">add</span> = (<span class="params">a, b</span>) =&gt; a + b;</span><br></pre></td></tr></table></figure>

<h2 id="Compile-TypeScript-files"><a href="#Compile-TypeScript-files" class="headerlink" title="Compile TypeScript files"></a>Compile TypeScript files</h2><p>This step will compile the <code>src/index.ts</code> file to <code>src/index.js</code> file.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> typescript-tsc-guide</span><br><span class="line">tsc</span><br></pre></td></tr></table></figure>

<h2 id="Compile-options"><a href="#Compile-options" class="headerlink" title="Compile options"></a>Compile options</h2><h3 id="outDir"><a href="#outDir" class="headerlink" title="outDir"></a>outDir</h3><p>Usually, we put the emitted files under <code>dist</code> folder. To do this, we need to modify the <code>tsconfig.json</code> file.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;outDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./dist&quot;</span> <span class="comment">// output directory for the emitted files</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>Run <code>tsc</code> again, the emitted files will be under <code>dist</code> folder.</p>
<h3 id="rootDir"><a href="#rootDir" class="headerlink" title="rootDir"></a>rootDir</h3><p>We can also specify the source folder by using <code>rootDir</code> option, in this way, only files under the source folder will be compiled.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;outDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./dist&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rootDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./src&quot;</span> <span class="comment">// specify the source folder</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>If you specify the <code>rootDir</code> option, you can’t put the source files outside the source folder. otherwise you’ll got the following error:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error TS6059: File <span class="string">&#x27;/typescript-tsc-guide/xxx.ts&#x27;</span> is not under <span class="string">&#x27;rootDir&#x27;</span> <span class="string">&#x27;/typescript-tsc-guide/src&#x27;</span>. <span class="string">&#x27;rootDir&#x27;</span> is expected to contain all <span class="built_in">source</span> files.</span><br></pre></td></tr></table></figure>

<p>To test this, create a file <code>test.ts</code> under project root(same location as tsconfig.json) and run <code>tsc</code> command, you’ll get the error.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/14/angular-customize-webpack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/14/angular-customize-webpack/" class="post-title-link" itemprop="url">angular-customize-webpack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-09-14 21:23:49 / Modified: 21:52:06" itemprop="dateCreated datePublished" datetime="2024-09-14T21:23:49+08:00">2024-09-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Angular 隐藏了项目构建的细节，其构建过程通过各种Builder来实现，底层可以使用Webpack或者ESBuild（从Angular17开始，默认使用ESBuild），那么我们需要修改Webpack配置怎么办呢？其实只有一个办法，那就是通过第三方npm package，这里介绍目前流行的两个。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/ngx-build-plus">ngx-build-plus</a> - Angular Module Federation也是用的这个package来做Webpack定制化。</li>
<li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@angular-builders/custom-webpack">@angular-builders&#x2F;custom-webpack</a></li>
</ul>
<p>这两者的实现原理也比较简单，都是通过继承<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@angular-devkit/build-angular">@angular-devkit&#x2F;build-angular</a>来实现的。</p>
<p>下面我们分别看看，这两个package的使用方法。</p>
<h2 id="ngx-build-plus"><a href="#ngx-build-plus" class="headerlink" title="ngx-build-plus"></a>ngx-build-plus</h2><h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install ngx-build-plus --save-dev</span><br></pre></td></tr></table></figure>

<h3 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h3><p><code>angular.json</code>(for Angular project) or <code>project.json</code>(For Nx based mono repo)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;architect&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;builder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ngx-build-plus:browser&quot;</span><span class="punctuation">,</span> <span class="comment">// change builder</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;extraWebpackConfig&quot;</span><span class="punctuation">:</span> <span class="string">&quot;extra-webpack.config.js&quot;</span> <span class="comment">// supply a path to the custom webpack config</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="angular-builders-x2F-custom-webpack"><a href="#angular-builders-x2F-custom-webpack" class="headerlink" title="@angular-builders&#x2F;custom-webpack"></a>@angular-builders&#x2F;custom-webpack</h2><h3 id="Installation-1"><a href="#Installation-1" class="headerlink" title="Installation"></a>Installation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @angular-builders/custom-webpack --save-dev</span><br></pre></td></tr></table></figure>

<h3 id="Usage-1"><a href="#Usage-1" class="headerlink" title="Usage"></a>Usage</h3><p><code>angular.json</code>(for Angular project) or <code>project.json</code>(For Nx based mono repo)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;architect&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;builder&quot;</span><span class="punctuation">:</span> <span class="string">&quot;@angular-builders/custom-webpack:browser&quot;</span><span class="punctuation">,</span> <span class="comment">// change builder</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;customWebpackConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./extra-webpack.config.js&quot;</span><span class="punctuation">,</span> <span class="comment">// supply a path to the custom webpack config</span></span><br><span class="line">          <span class="attr">&quot;mergeStrategies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;externals&quot;</span><span class="punctuation">:</span> <span class="string">&quot;replace&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="How-to-choose"><a href="#How-to-choose" class="headerlink" title="How to choose?"></a>How to choose?</h2><ol>
<li>If you are using Angular Module Federation, you should use <code>ngx-build-plus</code>, and it is installed automatically when you create a new Angular project with Angular Module Federation. This package has not been upgraded for a long time, but it is still working. <code>ngx-build-plus</code> support <code>hooks</code>.</li>
<li>If you are not using Angular Module Federation, you can choose either of them, but <code>@angular-builders/custom-webpack</code> is more popular. This package is upgraded frequently.</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/12/angular-build-process/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/12/angular-build-process/" class="post-title-link" itemprop="url">angular-build-process</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-12 20:45:25" itemprop="dateCreated datePublished" datetime="2024-09-12T20:45:25+08:00">2024-09-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-14 10:08:40" itemprop="dateModified" datetime="2024-09-14T10:08:40+08:00">2024-09-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Angular的编译过程是怎样的？<br>通常我么使用<code>ng build</code>命令来编译Angular项目，但是这个命令背后的逻辑是怎样的呢？</p>
<ul>
<li><code>ng build</code>命令底层是用<code>WebPack</code>还是<code>ESBuild</code>？</li>
<li><code>ng build</code>命令是如何处理<code>TypeScript</code>文件的？</li>
<li><code>ng build</code>命令是如何处理<code>HTML</code>文件的？</li>
</ul>
<h2 id="ts-x2F-js编译"><a href="#ts-x2F-js编译" class="headerlink" title="ts&#x2F;js编译"></a>ts&#x2F;js编译</h2><p>Webpack的配置文件在这里：<code>packages/angular_devkit/build_angular/src/tools/webpack/configs/common.ts</code></p>
<p>这个文件里我们可以看到如下<code>rule</code>配置：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">test</span>: <span class="regexp">/\.[cm]?[tj]sx?$/</span>,</span><br><span class="line">  <span class="comment">// The below is needed due to a bug in `@babel/runtime`. See: https://github.com/babel/babel/issues/12824</span></span><br><span class="line">  <span class="attr">resolve</span>: &#123; <span class="attr">fullySpecified</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">  <span class="attr">exclude</span>: [</span><br><span class="line">    <span class="regexp">/[\\/]node_modules[/\\](?:core-js|@babel|tslib|web-animations-js|web-streams-polyfill|whatwg-url)[/\\]/</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">use</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">loader</span>: <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;../../babel/webpack-loader&#x27;</span>),</span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">cacheDirectory</span>: (cache.<span class="property">enabled</span> &amp;&amp; path.<span class="title function_">join</span>(cache.<span class="property">path</span>, <span class="string">&#x27;babel-webpack&#x27;</span>)) || <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">aot</span>: buildOptions.<span class="property">aot</span>,</span><br><span class="line">        <span class="attr">optimize</span>: buildOptions.<span class="property">buildOptimizer</span>,</span><br><span class="line">        <span class="attr">supportedBrowsers</span>: buildOptions.<span class="property">supportedBrowsers</span>,</span><br><span class="line">        <span class="attr">instrumentCode</span>: codeCoverage</span><br><span class="line">          ? &#123;</span><br><span class="line">              <span class="attr">includedBasePath</span>: sourceRoot ?? projectRoot,</span><br><span class="line">              <span class="attr">excludedPaths</span>: <span class="title function_">getInstrumentationExcludedPaths</span>(root, codeCoverageExclude),</span><br><span class="line">            &#125;</span><br><span class="line">          : <span class="literal">undefined</span>,</span><br><span class="line">      &#125; <span class="keyword">as</span> <span class="title class_">AngularBabelLoaderOptions</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>可以看到这个正则表达式匹配的是：</p>
<ul>
<li><code>.ts</code>、<code>.tsx</code></li>
<li><code>.js</code>、<code>.jsx</code></li>
<li><code>.cjs</code>、<code>.mjs</code></li>
</ul>
<p>这些文件都会被<code>require.resolve(&#39;../../babel/webpack-loader&#39;)</code>这个loader处理。而这个loader的代码在这里：<code>packages/angular_devkit/build_angular/src/tools/babel/webpack-loader.ts</code></p>
<p>这个文件里面又调用了babelLoader。所以可知，<code>ng build</code>命令底层是用<code>Babel</code>来处理<code>TypeScript</code>文件的。</p>
<p>这里可以画一个流程图：ng build -&gt; Webpack -&gt; Babel -&gt; TypeScript</p>
<h2 id="scss-x2F-sass-x2F-less-x2F-css编译"><a href="#scss-x2F-sass-x2F-less-x2F-css编译" class="headerlink" title="scss&#x2F;sass&#x2F;less&#x2F;css编译"></a>scss&#x2F;sass&#x2F;less&#x2F;css编译</h2><p>Webpack通过各种loader来处理不同类型的文件，比如<code>css-loader</code>、<code>sass-loader</code>、<code>less-loader</code>等。那么什么是loader呢？loader是一个转换器，负责把一种文件格式转换为另一种文件格式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">output_format = loader(input_format)</span><br></pre></td></tr></table></figure>

<p>loader是可以链式调用的，上一个loader的输出可以作为下一个loader的输入，比如<code>scss</code>文件可以先经过<code>sass-loader</code>处理，然后再经过<code>css-loader</code>处理，最后再经过<code>style-loader</code>处理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">output_format = style-loader(css-loader(sass-loader(input_format)))</span><br></pre></td></tr></table></figure>

<p>Angular默认采用<code>scss</code>作为样式文件的扩展名，所以我们可以看到<code>scss</code>文件是如何被处理的：Webpack中关于样式文件的配置在这里：<code>packages/angular_devkit/build_angular/src/tools/webpack/configs/styles.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">extensions</span>: [<span class="string">&#x27;scss&#x27;</span>],</span><br><span class="line">  <span class="attr">use</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">loader</span>: <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;resolve-url-loader&#x27;</span>),</span><br><span class="line">      <span class="attr">options</span>: &#123;</span><br><span class="line">        <span class="attr">sourceMap</span>: cssSourceMap,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">loader</span>: <span class="built_in">require</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;sass-loader&#x27;</span>),</span><br><span class="line">      <span class="attr">options</span>: <span class="title function_">getSassLoaderOptions</span>(</span><br><span class="line">        root,</span><br><span class="line">        sassImplementation,</span><br><span class="line">        includePaths,</span><br><span class="line">        <span class="literal">false</span>,</span><br><span class="line">        !!buildOptions.<span class="property">verbose</span>,</span><br><span class="line">        !!buildOptions.<span class="property">preserveSymlinks</span>,</span><br><span class="line">      ),</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="html编译"><a href="#html编译" class="headerlink" title="html编译"></a>html编译</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/09/angular-how-ng-serve-works/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Philip Zhang">
      <meta itemprop="description" content="青春都一餉，忍把浮名換了代碼輕狂。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Philip">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/09/angular-how-ng-serve-works/" class="post-title-link" itemprop="url">angular-how-ng-serve-works</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-09 22:19:19" itemprop="dateCreated datePublished" datetime="2024-09-09T22:19:19+08:00">2024-09-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-19 10:30:46" itemprop="dateModified" datetime="2024-09-19T10:30:46+08:00">2024-09-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Angular的CLI(Command Line Interface)系统非常强大，它提供了丰富的命令用来构建，测试，运行Angular程序，今天我们就从源码的角度来看看cli中的<code>ng serve</code>命令是如何工作的。</p>
<p><code>ng serve</code>是我们日常频繁使用的命令，它用来本地启动Angular项目，检测代码更新以做出响应，但是用了这么久的命令，你了解它的底层逻辑吗？下面的几个问题你是否思考过？</p>
<ol>
<li><code>ng serve</code>命令为什么没有输出文件到dist目录？</li>
<li><code>ng serve</code>命令是如何启动一个web server的？</li>
<li><code>ng serve</code>命令是如何监控文件变化的？</li>
<li><code>ng serve</code>命令是如何实现热更新的？</li>
</ol>
<p>下面就让我们开始这段愉快而又漫长的探索之旅吧！</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>为了调试<code>ng serve</code>命令，我们需要准备一个Angular项目，为了方便查看源码，我们将<a target="_blank" rel="noopener" href="https://github.com/angular/angular-cli">angluar-cli</a>的源码也下载到本地，然后打开两个IDE，一个查看待调试的项目代码，一个查看<code>angular-cli</code>的源码。对照起来看，简直不要太爽！</p>
<h2 id="从命令行开始"><a href="#从命令行开始" class="headerlink" title="从命令行开始"></a>从命令行开始</h2><p>如果你直接查看<code>ng serve</code>命令的源码，可能得不到什么有用的信息，<code>serve</code>命令对应的源码在这里：<code>packages/angular/cli/src/commands/serve/cli.ts</code>， 从以下代码可知，<code>serve</code>命令是继承自<code>ArchitectCommandModule</code>的，同时也实现了<code>CommandModuleImplementation</code>接口。而该文件本身只是做了一个简单的配置，具体的实现逻辑都在<code>ArchitectCommandModule</code>和<code>CommandModuleImplementation</code>中。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">ServeCommandModule</span></span><br><span class="line">  <span class="keyword">extends</span> <span class="title class_ inherited__">ArchitectCommandModule</span></span><br><span class="line">  <span class="keyword">implements</span> <span class="title class_">CommandModuleImplementation</span></span><br><span class="line">&#123;</span><br><span class="line">  multiTarget = <span class="literal">false</span>;</span><br><span class="line">  command = <span class="string">&#x27;serve [project]&#x27;</span>;</span><br><span class="line">  aliases = <span class="title class_">RootCommands</span>[<span class="string">&#x27;serve&#x27;</span>].<span class="property">aliases</span>;</span><br><span class="line">  describe = <span class="string">&#x27;Builds and serves your application, rebuilding on file changes.&#x27;</span>;</span><br><span class="line">  longDescriptionPath?: <span class="built_in">string</span> | <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还是调试吧，我们打开Angular项目，然后打开项目根目录下的<code>package.json</code>文件，找到<code>scripts</code>字段，你会看到如下内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;ng&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;start&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng serve&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng build&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;watch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ng build --watch --configuration development&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;compile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ngc&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jest --verbose&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;test:watch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jest --watch&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;prepare&quot;</span><span class="punctuation">:</span> <span class="string">&quot;husky install&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<p>想要深入理解<code>ng serve</code>命令，我们需要先了解<code>start</code>命令是如何工作的。我们通过调式该命令的方式来了解<code>ng serve</code>的底层逻辑。不同的IDE对应不同的调试方式：</p>
<ul>
<li>WebStorm: 点击<code>start</code>命令左侧的绿色三角按钮，然后选择<code>Debug &#39;start&#39;</code>，这样就可以进入<code>ng serve</code>的源码了。</li>
<li>VSCode: 鼠标悬停到<code>start</code>命令上，点击<code>Debug</code>按钮，这样就可以进入<code>ng serve</code>的源码了。</li>
</ul>
<p>使用这种方法可以进入调试状态，但是我们要在哪里设置断点呢？</p>
<p>对于<code>package.json</code>中的script区块中的命令，其实他们都对应<code>node_modules/.bin</code>下面的一个文件。以<code>ng serve</code>为例，因为它的命令由<code>ng</code>来引导，那么我们首先到<code>node_modules/.bin</code>目录下找到<code>ng</code>文件。</p>
<p>可是我们找到了三个<code>ng</code>文件，分别是<code>ng</code>, <code>ng.cmd</code>, <code>ng.ps1</code>，那么我们应该选择哪一个呢？其实通过扩展名就能看出来，我这里使用的是Windows系统，所以我们选择<code>ng.cmd</code>文件。</p>
<ul>
<li>ng - Unix shell script</li>
<li>ng.cmd - Windows batch file</li>
<li>ng.ps1 - Windows PowerShell script</li>
</ul>
<p>用记事本打开这个文件看看它的代码:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">ECHO</span> off</span><br><span class="line"><span class="keyword">GOTO</span> <span class="built_in">start</span></span><br><span class="line">:find_dp0</span><br><span class="line"><span class="built_in">SET</span> dp0=%~dp0</span><br><span class="line"><span class="keyword">EXIT</span> /b</span><br><span class="line">:<span class="built_in">start</span></span><br><span class="line"><span class="built_in">SETLOCAL</span></span><br><span class="line"><span class="keyword">CALL</span> :find_dp0</span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXIST</span> &quot;<span class="variable">%dp0%</span>\node.exe&quot; (</span><br><span class="line">  <span class="built_in">SET</span> &quot;_prog=<span class="variable">%dp0%</span>\node.exe&quot;</span><br><span class="line">) <span class="keyword">ELSE</span> (</span><br><span class="line">  <span class="built_in">SET</span> &quot;_prog=node&quot;</span><br><span class="line">  <span class="built_in">SET</span> PATHEXT=<span class="variable">%PATHEXT:;.JS;=;%</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">endLocal</span> &amp; <span class="keyword">goto</span> #_undefined_# <span class="number">2</span>&gt;<span class="built_in">NUL</span> || <span class="built_in">title</span> <span class="variable">%COMSPEC%</span> &amp; &quot;<span class="variable">%_prog%</span>&quot;  &quot;<span class="variable">%dp0%</span>\..\@angular\cli\bin\ng.js&quot; %*</span><br></pre></td></tr></table></figure>
<p>我们不必纠结于每一行代码的含义，简单分析下来，我们可以推断出这个脚本的作用就是用<code>node.exe</code>来调用<code>@angular/cli/bin/ng.js</code>文件。</p>
<p>好了，我们再去看一下这个<code>ng.js</code>文件，这个文件就是Angular CLI的入口文件。ng.js调用了同一目录下的<code>bootstrap.js</code>文件，<code>bootstrap.js</code>文件调用了<code>lib/init.ts</code>文件。<code>init.ts</code>又调用了<code>lib/cli/index.ts</code>文件，后续又有一大堆的调用。</p>
<p><code>bin/ng.js</code> –&gt; <code>bin/bootstrap.js</code> –&gt; <code>lib/init.ts</code> –&gt; <code>lib/cli/index.ts</code> –&gt; …</p>
<p>通过不断的设置断点并调试得知，最终在文件<code>packages/angular/cli/src/command-builder/architect-base-command-module.ts</code>中通过解析项目的配置文件<code>angular.json</code>，找到<code>serve</code>命令对应的<code>builder</code>，然后通过调用那个<code>builder</code>来启动一个web server。</p>
<p><code>architect-base-command-module.ts</code>对应的代码如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">async</span> <span class="title function_">runSingleTarget</span>(<span class="attr">target</span>: <span class="title class_">Target</span>, <span class="attr">options</span>: <span class="title class_">OtherOptions</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> architectHost = <span class="variable language_">this</span>.<span class="title function_">getArchitectHost</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">builderName</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    builderName = <span class="keyword">await</span> architectHost.<span class="title function_">getBuilderNameForTarget</span>(target); <span class="comment">// 获取builder名称</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="title function_">assertIsError</span>(e);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">onMissingTarget</span>(e.<span class="property">message</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h2 id="Webpack配置在哪里？"><a href="#Webpack配置在哪里？" class="headerlink" title="Webpack配置在哪里？"></a>Webpack配置在哪里？</h2><p>我们都知道，<code>ng serve</code>命令启动的是一个web server，而这是通过<code>webpack-dev-server</code>来实现的，那么这个webpack-dev-server的配置在哪里呢？我么可以在源码中找到如下目录：<br><code>packages/angular_devkit/build_angular/src/tools/webpack/configs/common.ts</code>，这个目录下有四个文件：</p>
<ul>
<li><code>common.ts</code> - 通用配置，主要是打包配置</li>
<li><code>dev-server.ts</code> - 开发服务器配置 - 我们要找的配置就在这里。</li>
<li><code>styles.ts</code> - 样式配置，用来处理各种样式文件, 如css, scss&#x2F;sass, less等</li>
<li><code>index.ts</code> - 导出上面三个文件</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Angular的CLI命令对应的逻辑源码并不在CLI命令本身中，而是在对应的builder中，builder源码在这个目录下：</p>
<ul>
<li><code>packages/angular/build/src/builders</code> - application builder</li>
<li><code>packages/angular_devkit/build_angular/src/builders</code> - other builders</li>
</ul>
<p>关于builder的详细介绍，可以参考之前的一篇博文：<a target="_blank" rel="noopener" href="https://zdd.github.io/2024/06/06/angular-builders/%EF%BC%8C">https://zdd.github.io/2024/06/06/angular-builders/，</a> 也可以参考Angular官方文档：<a target="_blank" rel="noopener" href="https://angular.dev/tools/cli/cli-builder/">https://angular.dev/tools/cli/cli-builder/</a></p>
<ul>
<li>ng server works in memory and never generate files to dist folder</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Philip Zhang</p>
  <div class="site-description" itemprop="description">青春都一餉，忍把浮名換了代碼輕狂。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">214</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">290</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Philip Zhang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
